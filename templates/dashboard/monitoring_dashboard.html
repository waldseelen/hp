
{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Monitoring Dashboard" %}{% endblock %}

{% block extra_head %}
<style>
  .dashboard-shell {
    width: min(100%, 74rem);
    margin: 0 auto;
    display: grid;
    gap: clamp(var(--space-5), 5vw, var(--space-7));
    padding-block: clamp(var(--space-5), 6vw, var(--space-7));
  }

  .dashboard-panel {
    background: rgba(15, 23, 42, 0.48);
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: var(--radius-lg);
    padding: clamp(var(--space-4), 4vw, var(--space-6));
    box-shadow: var(--shadow-sm);
  }

  .dashboard-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-3);
  }

  .dashboard-metrics {
    display: grid;
    gap: var(--space-4);
    grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
  }

  .dashboard-metric {
    display: grid;
    gap: var(--space-2);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    border: 1px solid rgba(230, 197, 71, 0.25);
    background: linear-gradient(135deg, rgba(230, 197, 71, 0.12), rgba(96, 165, 250, 0.1));
    box-shadow: var(--shadow-xs);
  }

  .dashboard-metric[data-status="success"] {
    border-color: rgba(52, 211, 153, 0.35);
    background: linear-gradient(135deg, rgba(52, 211, 153, 0.18), rgba(15, 118, 110, 0.12));
  }

  .dashboard-metric[data-status="warning"] {
    border-color: rgba(251, 191, 36, 0.35);
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.18), rgba(217, 119, 6, 0.12));
  }

  .dashboard-metric[data-status="error"] {
    border-color: rgba(248, 113, 113, 0.35);
    background: linear-gradient(135deg, rgba(248, 113, 113, 0.18), rgba(220, 38, 38, 0.12));
  }

  .metric-value {
    font-size: clamp(1.8rem, 3.5vw, 2.6rem);
    font-weight: var(--font-weight-bold);
  }

  .metric-label {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .chart-area {
    position: relative;
    min-height: 22rem;
  }

  .table-scroll {
    overflow-x: auto;
  }

  .monitor-table {
    width: 100%;
    border-collapse: collapse;
  }

  .monitor-table th,
  .monitor-table td {
    padding: var(--space-3);
    border-bottom: 1px solid rgba(148, 163, 184, 0.18);
    font-size: var(--font-size-sm);
    text-align: left;
  }

  .monitor-table th {
    color: var(--color-text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .status-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: var(--radius-full);
  }

  .status-dot.success { background: #34d399; }
  .status-dot.warning { background: #fbbf24; }
  .status-dot.error { background: #f87171; }
  .status-dot.info { background: #38bdf8; }
  .status-dot.critical { background: #f87171; }

  @media (max-width: 48rem) {
    .dashboard-shell {
      padding-inline: var(--space-4);
    }
  }
</style>
{% endblock %}

{% block content %}
<section class="page-section">
  <div class="dashboard-shell" data-animate="fade">
    <header class="dashboard-header">
      <div class="stack" style="gap: var(--space-2);">
        <span class="text-eyebrow">{% trans "Operations" %}</span>
        <h1 class="heading-display-lg">{% trans "System Monitoring" %}</h1>
        <p class="text-muted">{% trans "Track uptime, web vitals and push notification delivery at a glance." %}</p>
      </div>
      <button type="button" class="btn btn--primary" data-refresh>{% trans "Refresh" %}</button>
    </header>

    <section class="dashboard-panel">
      <h2 class="heading-title">{% trans "System Health" %}</h2>
      <div class="dashboard-metrics">
        <article class="dashboard-metric" data-status="success">
          <span class="metric-label">{% trans "System Status" %}</span>
          <span class="metric-value" id="system-status">{% trans "Online" %}</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Avg Response Time" %}</span>
          <span class="metric-value" id="response-time">{{ avg_response_time|floatformat:2 }} ms</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Requests (24h)" %}</span>
          <span class="metric-value" id="total-requests">{{ total_requests }}</span>
        </article>
        <article class="dashboard-metric" data-status="warning">
          <span class="metric-label">{% trans "Error Rate" %}</span>
          <span class="metric-value" id="error-rate">{{ error_rate|floatformat:1 }}%</span>
        </article>
      </div>
    </section>

    <section class="dashboard-panel">
      <h2 class="heading-title">{% trans "Core Web Vitals" %}</h2>
      <div class="chart-area" role="img" aria-label="{% trans 'Core Web Vitals distribution' %}">
        <canvas id="webVitalsChart"></canvas>
      </div>
      <div class="dashboard-metrics" style="margin-top: var(--space-4);">
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Largest Contentful Paint" %}</span>
          <span class="metric-value">{{ core_web_vitals.lcp|floatformat:2 }} s</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "First Input Delay" %}</span>
          <span class="metric-value">{{ core_web_vitals.fid|floatformat:0 }} ms</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Layout Shift" %}</span>
          <span class="metric-value">{{ core_web_vitals.cls|floatformat:3 }}</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Interaction to Next Paint" %}</span>
          <span class="metric-value">{{ core_web_vitals.inp|floatformat:0 }} ms</span>
        </article>
      </div>
    </section>

    <section class="dashboard-panel">
      <h2 class="heading-title">{% trans "Push Notifications" %}</h2>
      <div class="dashboard-metrics">
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Active Subscriptions" %}</span>
          <span class="metric-value">{{ push_stats.total_subscriptions }}</span>
        </article>
        <article class="dashboard-metric">
          <span class="metric-label">{% trans "Sent Today" %}</span>
          <span class="metric-value">{{ push_stats.notifications_sent_today }}</span>
        </article>
        <article class="dashboard-metric" data-status="success">
          <span class="metric-label">{% trans "Delivery Success" %}</span>
          <span class="metric-value">{{ push_stats.success_rate|floatformat:1 }}%</span>
        </article>
      </div>
    </section>

    <section class="dashboard-panel">
      <h2 class="heading-title">{% trans "Recent Errors" %}</h2>
      <div class="table-scroll">
        <table class="monitor-table">
          <thead>
            <tr>
              <th scope="col">{% trans "Level" %}</th>
              <th scope="col">{% trans "Message" %}</th>
              <th scope="col">{% trans "URL" %}</th>
              <th scope="col">{% trans "Count" %}</th>
              <th scope="col">{% trans "Last Occurred" %}</th>
              <th scope="col">{% trans "State" %}</th>
            </tr>
          </thead>
          <tbody id="recent-errors">
            {% for error in recent_errors %}
              <tr>
                <td>
                  <span class="status-badge">
                    <span class="status-dot {{ error.get_level_display|lower }}"></span>
                    {{ error.get_level_display }}
                  </span>
                </td>
                <td>{{ error.message|truncatechars:64 }}</td>
                <td>{{ error.url|default:'—'|truncatechars:48 }}</td>
                <td>{{ error.occurrence_count }}</td>
                <td>{{ error.last_occurred|timesince }} {% trans "ago" %}</td>
                <td>
                  {% if error.is_resolved %}
                    <span class="status-badge"><span class="status-dot success"></span>{% trans "Resolved" %}</span>
                  {% else %}
                    <span class="status-badge"><span class="status-dot error"></span>{% trans "Open" %}</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6">{% trans "No recent errors." %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="dashboard-panel">
      <h2 class="heading-title">{% trans "Performance Trend (7 days)" %}</h2>
      <div class="chart-area" role="img" aria-label="{% trans 'Performance trend chart' %}">
        <canvas id="performanceTrendChart"></canvas>
      </div>
    </section>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha384-NrKB+u6Ts6AtkIhwPixiKTzgSKNblyhlk0Sohlgar9UHUBzai/sgnNNWWd291xqt" crossorigin="anonymous"></script>
<script>
  const chartPalette = {
    lcp: '#60a5fa',
    fid: '#a855f7',
    good: '#34d399',
    meh: '#fbbf24',
    bad: '#f87171'
  };

  let webVitalsChart = null;
  let performanceTrendChart = null;

  document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    const refreshButton = document.querySelector('[data-refresh]');
    if (refreshButton) {
      refreshButton.addEventListener('click', refreshDashboard, { passive: true });
    }
    setInterval(refreshDashboard, 30000);
  });

  function initCharts() {
    const webVitalsTarget = document.getElementById('webVitalsChart');
    if (webVitalsTarget) {
      webVitalsChart = new Chart(webVitalsTarget, {
        type: 'doughnut',
        data: {
          labels: ['{% trans "Good" %}', '{% trans "Needs Improvement" %}', '{% trans "Poor" %}'],
          datasets: [{
            data: [
              {{ core_web_vitals.good_count }},
              {{ core_web_vitals.needs_improvement_count }},
              {{ core_web_vitals.poor_count }}
            ],
            backgroundColor: [chartPalette.good, chartPalette.meh, chartPalette.bad],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: '{% trans "Performance score distribution" %}' }
          }
        }
      });
    }

    const trendTarget = document.getElementById('performanceTrendChart');
    if (trendTarget) {
      performanceTrendChart = new Chart(trendTarget, {
        type: 'line',
        data: {
          labels: {{ performance_trend.dates|safe }},
          datasets: [
            {
              label: '{% trans "LCP (s)" %}',
              data: {{ performance_trend.lcp_values|safe }},
              borderColor: chartPalette.lcp,
              backgroundColor: 'rgba(96, 165, 250, 0.12)',
              tension: 0.32,
              yAxisID: 'y'
            },
            {
              label: '{% trans "FID (ms)" %}',
              data: {{ performance_trend.fid_values|safe }},
              borderColor: chartPalette.fid,
              backgroundColor: 'rgba(168, 85, 247, 0.12)',
              tension: 0.32,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: '{% trans "LCP (seconds)" %}' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { drawOnChartArea: false },
              title: { display: true, text: '{% trans "FID (milliseconds)" %}' }
            }
          }
        }
      });
    }
  }

  async function refreshDashboard() {
    try {
      const response = await fetch('/api/performance/dashboard/', { headers: { 'Accept': 'application/json' } });
      if (!response.ok) {
        throw new Error('Request failed');
      }
      const payload = await response.json();
      updateDashboardData(payload);
    } catch (error) {
      console.warn('Dashboard refresh failed:', error);
    }
  }

  function updateDashboardData(data) {
    if (!data) {
      return;
    }
    document.getElementById('response-time').textContent = `${Number.parseFloat(data.avg_response_time || 0).toFixed(2)} ms`;
    document.getElementById('total-requests').textContent = data.total_requests ?? '0';
    document.getElementById('error-rate').textContent = `${Number.parseFloat(data.error_rate || 0).toFixed(1)}%`;

    if (webVitalsChart && data.core_web_vitals) {
      webVitalsChart.data.datasets[0].data = [
        data.core_web_vitals.good_count,
        data.core_web_vitals.needs_improvement_count,
        data.core_web_vitals.poor_count
      ];
      webVitalsChart.update();
    }

    if (performanceTrendChart && data.performance_trend) {
      performanceTrendChart.data.labels = data.performance_trend.dates;
      performanceTrendChart.data.datasets[0].data = data.performance_trend.lcp_values;
      performanceTrendChart.data.datasets[1].data = data.performance_trend.fid_values;
      performanceTrendChart.update();
    }

    if (Array.isArray(data.recent_errors)) {
      renderErrorsTable(data.recent_errors);
    }
  }

  function renderErrorsTable(items) {
    const target = document.getElementById('recent-errors');
    if (!target) {
      return;
    }

    if (!items.length) {
      target.innerHTML = `<tr><td colspan="6">{% trans "No recent errors." %}</td></tr>`;
      return;
    }

    const rows = items.map((item) => {
      const level = (item.level_display || '').toLowerCase();
      const status = item.is_resolved ? '{% trans "Resolved" %}' : '{% trans "Open" %}';
      const statusClass = item.is_resolved ? 'success' : 'error';
      return `
        <tr>
          <td><span class="status-badge"><span class="status-dot ${level}"></span>${item.level_display}</span></td>
          <td>${item.message}</td>
          <td>${item.url || '—'}</td>
          <td>${item.occurrence_count}</td>
          <td>${item.last_occurred_human || ''}</td>
          <td><span class="status-badge"><span class="status-dot ${statusClass}"></span>${status}</span></td>
        </tr>`;
    }).join('');

    target.innerHTML = rows;
  }
</script>
{% endblock %}
