{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Log Analysis Dashboard" %} - {% trans "Portfolio" %}{% endblock %}

{% block extra_css %}
<style>
    .log-card {
        @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg;
        transition: all 0.3s ease;
    }
    .log-card:hover {
        @apply border-gray-600 shadow-xl;
        transform: translateY(-2px);
    }

    .log-metric {
        @apply text-2xl font-bold;
    }

    .level-critical { @apply text-red-400; }
    .level-error { @apply text-red-300; }
    .level-warning { @apply text-yellow-400; }
    .level-info { @apply text-blue-400; }
    .level-debug { @apply text-gray-400; }

    .alert-card {
        @apply bg-red-900 border border-red-700 rounded-lg p-4 mb-4;
    }

    .log-entry {
        @apply bg-gray-900 border border-gray-700 rounded p-3 mb-2 text-sm;
        font-family: 'Courier New', monospace;
    }

    .log-search {
        @apply bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white;
    }

    .loading-spinner {
        @apply inline-block w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin;
    }

    .refresh-indicator {
        @apply text-xs text-gray-500 ml-2;
    }

    .filter-btn {
        @apply px-3 py-1 text-xs rounded border border-gray-600 bg-gray-700 text-gray-300 hover:bg-gray-600;
    }

    .filter-btn.active {
        @apply bg-blue-600 border-blue-500 text-white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval;
let isLoading = false;

function updateRefreshIndicator() {
    const indicator = document.getElementById('refreshIndicator');
    if (indicator) {
        const now = new Date();
        indicator.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
}

function showLoading() {
    isLoading = true;
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) spinner.classList.remove('hidden');
}

function hideLoading() {
    isLoading = false;
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) spinner.classList.add('hidden');
}

async function refreshLogData() {
    if (isLoading) return;

    showLoading();

    try {
        const params = new URLSearchParams({
            hours: document.getElementById('hoursSelect')?.value || '24',
            level: document.getElementById('levelFilter')?.value || '',
            logger: document.getElementById('loggerFilter')?.value || '',
            q: document.getElementById('searchInput')?.value || ''
        });

        const response = await fetch(`/api/logs/data/?${params}`);
        const data = await response.json();

        if (data.success) {
            updateStats(data.stats);
            updateSearchResults(data.search_results);
            updateAlerts(data.alerts);
            updateRefreshIndicator();
        } else {
            console.error('Failed to fetch log data:', data.error);
        }
    } catch (error) {
        console.error('Error fetching log data:', error);
    } finally {
        hideLoading();
    }
}

function updateStats(stats) {
    // Update log statistics
    const elements = {
        'totalEntries': stats.total_entries,
        'errorCount': stats.error_count,
        'warningCount': stats.warning_count
    };

    for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    }

    // Update level breakdown
    const levelContainer = document.getElementById('levelBreakdown');
    if (levelContainer && stats.by_level) {
        levelContainer.innerHTML = '';
        for (const [level, count] of Object.entries(stats.by_level)) {
            const levelDiv = document.createElement('div');
            levelDiv.className = `flex justify-between items-center py-1`;
            levelDiv.innerHTML = `
                <span class="level-${level.toLowerCase()}">${level}</span>
                <span class="font-mono">${count}</span>
            `;
            levelContainer.appendChild(levelDiv);
        }
    }
}

function updateSearchResults(results) {
    const container = document.getElementById('searchResults');
    if (!container) return;

    container.innerHTML = '';

    if (results.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No matching log entries found</div>';
        return;
    }

    results.forEach(entry => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'log-entry';
        entryDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="level-${entry.level.toLowerCase()} font-semibold">${entry.level}</span>
                <span class="text-gray-500 text-xs">${new Date(entry.timestamp).toLocaleString()}</span>
            </div>
            <div class="text-gray-300 mb-1">${entry.message}</div>
            <div class="text-gray-500 text-xs">
                Logger: ${entry.logger} | Service: ${entry.service || 'N/A'}
                ${entry.trace_id ? ` | Trace: ${entry.trace_id}` : ''}
            </div>
        `;
        container.appendChild(entryDiv);
    });
}

function updateAlerts(alerts) {
    const container = document.getElementById('alertsContainer');
    if (!container) return;

    container.innerHTML = '';

    if (alerts.length === 0) {
        container.innerHTML = '<div class="text-green-400 text-center py-4">✓ No active alerts</div>';
        return;
    }

    alerts.forEach(alert => {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert-card';
        alertDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-red-300">${alert.alert_type}</h4>
                    <p class="text-red-200 text-sm">${alert.message}</p>
                    <p class="text-red-400 text-xs mt-1">Severity: ${alert.severity}</p>
                </div>
                <button onclick="acknowledgeAlert('${alert.alert_type}', '${alert.timestamp}')"
                        class="px-2 py-1 text-xs bg-red-700 hover:bg-red-600 rounded">
                    Acknowledge
                </button>
            </div>
        `;
        container.appendChild(alertDiv);
    });
}

async function acknowledgeAlert(alertType, timestamp) {
    try {
        const response = await fetch('/api/logs/acknowledge/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                alert_type: alertType,
                timestamp: timestamp
            })
        });

        const data = await response.json();
        if (data.success) {
            refreshLogData(); // Refresh to update alerts
        } else {
            console.error('Failed to acknowledge alert:', data.error);
        }
    } catch (error) {
        console.error('Error acknowledging alert:', error);
    }
}

function exportLogs() {
    const params = new URLSearchParams({
        hours: document.getElementById('hoursSelect')?.value || '24',
        level: document.getElementById('levelFilter')?.value || '',
        logger: document.getElementById('loggerFilter')?.value || '',
        q: document.getElementById('searchInput')?.value || '',
        format: 'json'
    });

    window.open(`/api/logs/export/?${params}`, '_blank');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Initial load
    refreshLogData();

    // Set up auto-refresh
    refreshInterval = setInterval(refreshLogData, 30000); // 30 seconds

    // Set up search and filter handlers
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(refreshLogData, 500);
        });
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Toggle active state
            this.classList.toggle('active');
            refreshLogData();
        });
    });

    // Dropdown changes
    ['hoursSelect', 'levelFilter', 'loggerFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', refreshLogData);
        }
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">{% trans "Log Analysis Dashboard" %}</h1>
            <p class="text-gray-400">
                {% trans "Centralized log monitoring and analysis" %}
                <span id="refreshIndicator" class="refresh-indicator">
                    {% trans "Loading..." %}
                </span>
                <span id="loadingSpinner" class="loading-spinner ml-2 hidden"></span>
            </p>
        </div>
        <div class="flex space-x-3">
            <button onclick="refreshLogData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm">
                {% trans "Refresh" %}
            </button>
            <button onclick="exportLogs()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white text-sm">
                {% trans "Export" %}
            </button>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-white mb-4">{% trans "Active Alerts" %}</h2>
        <div id="alertsContainer">
            {% if alerts %}
                {% for alert in alerts %}
                <div class="alert-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-red-300">{{ alert.alert_type }}</h4>
                            <p class="text-red-200 text-sm">{{ alert.message }}</p>
                            <p class="text-red-400 text-xs mt-1">Severity: {{ alert.severity }}</p>
                        </div>
                        <button onclick="acknowledgeAlert('{{ alert.alert_type }}', '{{ alert.timestamp }}')"
                                class="px-2 py-1 text-xs bg-red-700 hover:bg-red-600 rounded">
                            {% trans "Acknowledge" %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-green-400 text-center py-4">✓ {% trans "No active alerts" %}</div>
            {% endif %}
        </div>
    </div>

    <!-- Log Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
        <div class="log-card">
            <h3 class="text-gray-400 text-sm mb-2">{% trans "Total Entries" %}</h3>
            <div id="totalEntries" class="log-metric text-blue-400">
                {{ report.summary.total_log_entries|default:0 }}
            </div>
        </div>

        <div class="log-card">
            <h3 class="text-gray-400 text-sm mb-2">{% trans "Errors" %}</h3>
            <div id="errorCount" class="log-metric level-error">
                {{ report.summary.error_count|default:0 }}
            </div>
        </div>

        <div class="log-card">
            <h3 class="text-gray-400 text-sm mb-2">{% trans "Warnings" %}</h3>
            <div id="warningCount" class="log-metric level-warning">
                {{ report.summary.warning_count|default:0 }}
            </div>
        </div>

        <div class="log-card">
            <h3 class="text-gray-400 text-sm mb-2">{% trans "Log Levels" %}</h3>
            <div id="levelBreakdown" class="text-sm space-y-1">
                {% if report.summary.by_level %}
                    {% for level, count in report.summary.by_level.items %}
                    <div class="flex justify-between items-center">
                        <span class="level-{{ level|lower }}">{{ level }}</span>
                        <span class="font-mono">{{ count }}</span>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="log-card mb-8">
        <h3 class="text-xl font-semibold text-white mb-4">{% trans "Search & Filter" %}</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Search Input -->
            <div>
                <label class="block text-gray-400 text-sm mb-2">{% trans "Search Logs" %}</label>
                <input type="text" id="searchInput" placeholder="Search messages..."
                       class="log-search w-full">
            </div>

            <!-- Time Range -->
            <div>
                <label class="block text-gray-400 text-sm mb-2">{% trans "Time Range" %}</label>
                <select id="hoursSelect" class="log-search w-full">
                    <option value="1" {% if hours_back == 1 %}selected{% endif %}>Last Hour</option>
                    <option value="6" {% if hours_back == 6 %}selected{% endif %}>Last 6 Hours</option>
                    <option value="24" {% if hours_back == 24 %}selected{% endif %}>Last 24 Hours</option>
                    <option value="168" {% if hours_back == 168 %}selected{% endif %}>Last Week</option>
                </select>
            </div>

            <!-- Log Level Filter -->
            <div>
                <label class="block text-gray-400 text-sm mb-2">{% trans "Log Level" %}</label>
                <select id="levelFilter" class="log-search w-full">
                    <option value="">All Levels</option>
                    <option value="CRITICAL">Critical</option>
                    <option value="ERROR">Error</option>
                    <option value="WARNING">Warning</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>

            <!-- Logger Filter -->
            <div>
                <label class="block text-gray-400 text-sm mb-2">{% trans "Logger" %}</label>
                <select id="loggerFilter" class="log-search w-full">
                    <option value="">All Loggers</option>
                    <option value="main">Main</option>
                    <option value="django">Django</option>
                    <option value="performance">Performance</option>
                    <option value="security">Security</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Log Entries -->
    <div class="log-card">
        <h3 class="text-xl font-semibold text-white mb-4">{% trans "Recent Log Entries" %}</h3>
        <div id="searchResults" class="max-h-96 overflow-y-auto">
            <div class="text-gray-500 text-center py-4">{% trans "Use search filters to view log entries" %}</div>
        </div>
    </div>
</div>
{% endblock %}
