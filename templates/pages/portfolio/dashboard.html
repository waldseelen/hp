{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Performance Dashboard" %} - {% trans "Portfolio" %}{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg;
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        @apply border-gray-600 shadow-xl;
        transform: translateY(-2px);
    }

    .metric-value {
        @apply text-3xl font-bold;
    }

    .status-good { @apply text-green-400; }
    .status-needs-improvement { @apply text-yellow-400; }
    .status-poor { @apply text-red-400; }
    .status-unknown { @apply text-gray-400; }

    .health-score-A { @apply bg-green-600; }
    .health-score-B { @apply bg-blue-600; }
    .health-score-C { @apply bg-yellow-600; }
    .health-score-D { @apply bg-orange-600; }
    .health-score-F { @apply bg-red-600; }

    .alert-card {
        @apply bg-red-900 border border-red-700 rounded-lg p-4 mb-4;
    }

    .chart-container {
        @apply bg-gray-800 border border-gray-700 rounded-lg p-6;
        min-height: 400px;
    }

    .loading-spinner {
        @apply inline-block w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin;
    }

    .refresh-indicator {
        @apply text-xs text-gray-500 ml-2;
    }

    .metric-trend-up { @apply text-red-400; }
    .metric-trend-down { @apply text-green-400; }
    .metric-trend-stable { @apply text-gray-400; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Dashboard Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <h1 class="heading-1">{% trans "Performance Dashboard" %}</h1>
            <div class="flex items-center space-x-4">
                <!-- Auto-refresh indicator -->
                <div class="flex items-center text-sm text-gray-400">
                    <div id="refresh-indicator" class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                    <span>{% trans "Auto-refresh" %} <span id="refresh-countdown">30</span>s</span>
                </div>

                <!-- Health Score Badge -->
                <div class="health-score-badge health-score-{{ health_status.health_score|default:'F' }} text-white px-3 py-1 rounded-full text-sm font-bold">
                    {% trans "Health Score" %}: {{ health_status.health_score|default:"F" }}
                </div>
            </div>
        </div>

        <p class="body-large text-gray-300">
            {% trans "Real-time Core Web Vitals monitoring and performance analytics" %}
        </p>
    </div>

    <!-- Alert Section -->
    {% if recent_alerts %}
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
            <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            {% trans "Recent Alerts" %}
        </h2>

        <div class="space-y-3">
            {% for alert in recent_alerts %}
            <div class="alert-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-red-100">{{ alert.metric_type|upper }} {% trans "Alert" %}</h3>
                        <p class="text-red-200 text-sm">
                            {% trans "Triggered" %} {{ alert.minutes_ago }} {% trans "minutes ago" %}
                            {% if alert.threshold %}
                            â€¢ {% trans "Threshold" %}: {{ alert.threshold }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-xs text-red-300">
                        {{ alert.triggered_at|date:"H:i" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Core Web Vitals Section -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-6">{% trans "Core Web Vitals" %}</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- LCP -->
            {% with lcp=metrics_summary.metrics.lcp %}
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">LCP</h3>
                    {% if lcp.status %}
                    <span class="status-{{ lcp.status }} text-sm font-medium">{{ lcp.status|title }}</span>
                    {% endif %}
                </div>
                <div class="metric-value text-{{ lcp.status|default:'unknown' }}">
                    {{ lcp.average|default:0|floatformat:2 }}ms
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "Largest Contentful Paint" %}<br>
                    {% if lcp.count %}{{ lcp.count }} {% trans "samples" %}{% endif %}
                </div>
            </div>
            {% endwith %}

            <!-- FID -->
            {% with fid=metrics_summary.metrics.fid %}
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">FID</h3>
                    {% if fid.status %}
                    <span class="status-{{ fid.status }} text-sm font-medium">{{ fid.status|title }}</span>
                    {% endif %}
                </div>
                <div class="metric-value text-{{ fid.status|default:'unknown' }}">
                    {{ fid.average|default:0|floatformat:1 }}ms
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "First Input Delay" %}<br>
                    {% if fid.count %}{{ fid.count }} {% trans "samples" %}{% endif %}
                </div>
            </div>
            {% endwith %}

            <!-- CLS -->
            {% with cls=metrics_summary.metrics.cls %}
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">CLS</h3>
                    {% if cls.status %}
                    <span class="status-{{ cls.status }} text-sm font-medium">{{ cls.status|title }}</span>
                    {% endif %}
                </div>
                <div class="metric-value text-{{ cls.status|default:'unknown' }}">
                    {{ cls.average|default:0|floatformat:3 }}
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "Cumulative Layout Shift" %}<br>
                    {% if cls.count %}{{ cls.count }} {% trans "samples" %}{% endif %}
                </div>
            </div>
            {% endwith %}
        </div>
    </div>

    <!-- Additional Metrics Section -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-6">{% trans "Additional Metrics" %}</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- TTFB -->
            {% with ttfb=metrics_summary.metrics.ttfb %}
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">TTFB</h3>
                    {% if ttfb.status %}
                    <span class="status-{{ ttfb.status }} text-sm font-medium">{{ ttfb.status|title }}</span>
                    {% endif %}
                </div>
                <div class="metric-value text-{{ ttfb.status|default:'unknown' }}">
                    {{ ttfb.average|default:0|floatformat:0 }}ms
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "Time to First Byte" %}
                </div>
            </div>
            {% endwith %}

            <!-- FCP -->
            {% with fcp=metrics_summary.metrics.fcp %}
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">FCP</h3>
                    {% if fcp.status %}
                    <span class="status-{{ fcp.status }} text-sm font-medium">{{ fcp.status|title }}</span>
                    {% endif %}
                </div>
                <div class="metric-value text-{{ fcp.status|default:'unknown' }}">
                    {{ fcp.average|default:0|floatformat:0 }}ms
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "First Contentful Paint" %}
                </div>
            </div>
            {% endwith %}

            <!-- Active Alerts -->
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">{% trans "Alerts" %}</h3>
                    {% if health_status.active_alerts > 0 %}
                    <span class="status-poor text-sm font-medium">{% trans "Active" %}</span>
                    {% else %}
                    <span class="status-good text-sm font-medium">{% trans "Clear" %}</span>
                    {% endif %}
                </div>
                <div class="metric-value {% if health_status.active_alerts > 0 %}text-red-400{% else %}text-green-400{% endif %}">
                    {{ health_status.active_alerts|default:0 }}
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "Active alerts" %}
                </div>
            </div>

            <!-- Total Metrics -->
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">{% trans "Metrics" %}</h3>
                </div>
                <div class="metric-value text-blue-400">
                    {{ metrics_summary.total_entries|default:0 }}
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    {% trans "Collected metrics" %}
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Data Section -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
            {% trans "Real-time Status" %}
            <span id="loading-indicator" class="loading-spinner ml-2 hidden"></span>
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Current Metrics -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">{% trans "Current Performance" %}</h3>
                <div id="current-metrics" class="space-y-4">
                    {% for metric_type, data in real_time_data.current_metrics.items %}
                    <div class="flex items-center justify-between py-2 border-b border-gray-700">
                        <span class="text-gray-300">{{ metric_type|upper }}</span>
                        <div class="text-right">
                            <span class="text-white font-bold">{{ data.latest|floatformat:2 }}</span>
                            <span class="text-xs text-gray-400 ml-2">
                                (avg: {{ data.average_5min|floatformat:2 }})
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-400 py-8">
                        {% trans "No real-time data available" %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- System Health -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">{% trans "System Health" %}</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">{% trans "Overall Status" %}</span>
                        <span class="{% if health_status.status == 'healthy' %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                            {{ health_status.status|title }}
                        </span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">{% trans "Health Score" %}</span>
                        <span class="text-white font-bold">{{ health_status.health_score|default:"F" }}</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">{% trans "Metrics Collected" %}</span>
                        <span class="text-white font-bold">{{ health_status.metrics_count|default:0 }}</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">{% trans "Active Alerts" %}</span>
                        <span class="{% if health_status.active_alerts > 0 %}text-red-400{% else %}text-green-400{% endif %} font-bold">
                            {{ health_status.active_alerts|default:0 }}
                        </span>
                    </div>

                    <div class="pt-4 border-t border-gray-700">
                        <span class="text-xs text-gray-400">
                            {% trans "Last updated" %}: <span id="last-updated">{{ health_status.timestamp|date:"H:i:s" }}</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Dashboard JavaScript -->
<script>
class PerformanceDashboard {
    constructor() {
        this.refreshInterval = {{ dashboard_refresh_interval|default:30000 }};
        this.countdownTimer = null;
        this.refreshTimer = null;
        this.countdownValue = 30;

        this.init();
    }

    init() {
        console.log('Performance Dashboard initialized');
        this.startAutoRefresh();
        this.bindEvents();
    }

    startAutoRefresh() {
        // Start countdown
        this.startCountdown();

        // Set refresh timer
        this.refreshTimer = setInterval(() => {
            this.refreshData();
        }, this.refreshInterval);
    }

    startCountdown() {
        this.countdownValue = this.refreshInterval / 1000;
        const countdownEl = document.getElementById('refresh-countdown');

        this.countdownTimer = setInterval(() => {
            this.countdownValue--;
            if (countdownEl) {
                countdownEl.textContent = this.countdownValue;
            }

            if (this.countdownValue <= 0) {
                this.countdownValue = this.refreshInterval / 1000;
            }
        }, 1000);
    }

    async refreshData() {
        const loadingIndicator = document.getElementById('loading-indicator');
        const refreshIndicator = document.getElementById('refresh-indicator');

        try {
            // Show loading state
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (refreshIndicator) refreshIndicator.classList.add('bg-yellow-400', 'animate-pulse');

            // Fetch real-time data
            const response = await fetch('/api/performance/dashboard/?realtime=true');
            const data = await response.json();

            if (data.status === 'success') {
                this.updateMetrics(data);
                this.updateLastUpdated();

                // Success state
                if (refreshIndicator) {
                    refreshIndicator.classList.remove('bg-yellow-400');
                    refreshIndicator.classList.add('bg-green-400');
                }
            } else {
                throw new Error(data.message || 'Failed to fetch data');
            }

        } catch (error) {
            console.error('Dashboard refresh error:', error);

            // Error state
            if (refreshIndicator) {
                refreshIndicator.classList.remove('bg-yellow-400', 'bg-green-400');
                refreshIndicator.classList.add('bg-red-400');
            }

            setTimeout(() => {
                if (refreshIndicator) {
                    refreshIndicator.classList.remove('bg-red-400');
                    refreshIndicator.classList.add('bg-green-400');
                }
            }, 3000);

        } finally {
            // Hide loading state
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        }
    }

    updateMetrics(data) {
        // Update current metrics
        const currentMetricsEl = document.getElementById('current-metrics');
        if (currentMetricsEl && data.data.current_metrics) {
            // Could implement real-time metric updates here
            console.log('Real-time metrics:', data.data.current_metrics);
        }
    }

    updateLastUpdated() {
        const lastUpdatedEl = document.getElementById('last-updated');
        if (lastUpdatedEl) {
            const now = new Date();
            lastUpdatedEl.textContent = now.toLocaleTimeString();
        }
    }

    bindEvents() {
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.pauseRefresh();
            } else {
                this.resumeRefresh();
            }
        });

        // Handle manual refresh if button is added
        const refreshButton = document.getElementById('manual-refresh');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                this.refreshData();
            });
        }
    }

    pauseRefresh() {
        if (this.refreshTimer) {
            clearInterval(this.refreshTimer);
            this.refreshTimer = null;
        }
        if (this.countdownTimer) {
            clearInterval(this.countdownTimer);
            this.countdownTimer = null;
        }
    }

    resumeRefresh() {
        if (!this.refreshTimer) {
            this.startAutoRefresh();
        }
    }

    destroy() {
        this.pauseRefresh();
    }
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.performanceDashboard = new PerformanceDashboard();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (window.performanceDashboard) {
        window.performanceDashboard.destroy();
    }
});
</script>

<!-- Chart.js for future chart implementations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}