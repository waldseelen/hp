{% extends "base.html" %}
{% load static %}

{% block title %}Search Results - {{ query|default:"" }}{% endblock %}

{% block extra_css %}
<style>
    /* Search Results Styles */
    .search-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .search-header {
        margin-bottom: 2rem;
    }

    .search-input-wrapper {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .search-input {
        width: 100%;
        padding: 1rem 3rem 1rem 1rem;
        font-size: 1.125rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .search-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-stats {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .search-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .filter-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .search-results {
        display: grid;
        gap: 1.5rem;
    }

    .result-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.2s;
    }

    .result-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
    }

    .result-header {
        display: flex;
        align-items: start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .result-icon {
        font-size: 2rem;
        flex-shrink: 0;
    }

    .result-content {
        flex: 1;
        min-width: 0;
    }

    .result-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #111827;
    }

    .result-title a {
        color: inherit;
        text-decoration: none;
    }

    .result-title a:hover {
        color: #3b82f6;
    }

    .result-title mark {
        background: #fef3c7;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
    }

    .result-category {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #f3f4f6;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .result-excerpt {
        color: #4b5563;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .result-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #9ca3af;
    }

    .result-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .result-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .tag {
        padding: 0.25rem 0.75rem;
        background: #eff6ff;
        color: #1e40af;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 3rem;
    }

    .page-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #111827;
    }

    .empty-state-text {
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }

    .spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .search-meta {
            flex-direction: column;
            align-items: flex-start;
        }

        .result-header {
            flex-direction: column;
        }

        .result-icon {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <!-- Search Header -->
    <div class="search-header">
        <div class="search-input-wrapper" x-data="searchBar()">
            <input
                type="text"
                class="search-input"
                placeholder="Search articles, tools, resources..."
                x-model="query"
                @input.debounce.300ms="search()"
                @keydown.enter="search()"
            >
            <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>
    </div>

    <div x-data="searchResults()" x-init="init()">
        <!-- Search Meta & Filters -->
        <div class="search-meta" x-show="!loading && results.length > 0">
            <div class="search-stats">
                <span x-text="totalResults"></span> results found
                <template x-if="performanceMs">
                    <span>in <span x-text="performanceMs"></span>ms</span>
                </template>
            </div>

            <div class="search-filters">
                <button
                    class="filter-btn"
                    :class="{ 'active': !activeFilter }"
                    @click="filterByCategory(null)"
                >
                    All
                </button>
                <template x-for="(count, category) in facets" :key="category">
                    <button
                        class="filter-btn"
                        :class="{ 'active': activeFilter === category }"
                        @click="filterByCategory(category)"
                    >
                        <span x-text="category"></span>
                        <span x-text="`(${count})`"></span>
                    </button>
                </template>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" x-show="loading">
            <div class="spinner"></div>
            <p>Searching...</p>
        </div>

        <!-- Search Results -->
        <div class="search-results" x-show="!loading && results.length > 0">
            <template x-for="result in results" :key="result.id">
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-icon" x-text="result.icon"></div>
                        <div class="result-content">
                            <div class="result-category" x-text="result.category"></div>
                            <h3 class="result-title">
                                <a :href="result.url" x-html="result.title"></a>
                            </h3>
                            <p class="result-excerpt" x-text="result.excerpt"></p>

                            <!-- Metadata -->
                            <div class="result-meta" x-show="hasMetadata(result)">
                                <template x-if="result.metadata.published_date">
                                    <div class="result-meta-item">
                                        <span>üìÖ</span>
                                        <span x-text="result.metadata.published_date"></span>
                                    </div>
                                </template>
                                <template x-if="result.metadata.reading_time">
                                    <div class="result-meta-item">
                                        <span>‚è±</span>
                                        <span x-text="result.metadata.reading_time"></span>
                                    </div>
                                </template>
                                <template x-if="result.metadata.views">
                                    <div class="result-meta-item">
                                        <span>üëÅ</span>
                                        <span x-text="result.metadata.views + ' views'"></span>
                                    </div>
                                </template>
                                <template x-if="result.metadata.rating">
                                    <div class="result-meta-item">
                                        <span>‚≠ê</span>
                                        <span x-text="result.metadata.rating + '/5'"></span>
                                    </div>
                                </template>
                            </div>

                            <!-- Tags -->
                            <div class="result-tags" x-show="result.tags && result.tags.length > 0">
                                <template x-for="tag in result.tags" :key="tag">
                                    <span class="tag" x-text="tag"></span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div class="empty-state" x-show="!loading && results.length === 0 && query">
            <div class="empty-state-icon">üîç</div>
            <h2 class="empty-state-title">No results found</h2>
            <p class="empty-state-text">
                Try different keywords or check your spelling
            </p>
        </div>

        <!-- Pagination -->
        <div class="pagination" x-show="!loading && totalPages > 1">
            <button
                class="page-btn"
                @click="goToPage(currentPage - 1)"
                :disabled="!hasPrev"
            >
                Previous
            </button>

            <template x-for="page in visiblePages" :key="page">
                <button
                    class="page-btn"
                    :class="{ 'active': page === currentPage }"
                    @click="goToPage(page)"
                    x-text="page"
                ></button>
            </template>

            <button
                class="page-btn"
                @click="goToPage(currentPage + 1)"
                :disabled="!hasNext"
            >
                Next
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function searchBar() {
        return {
            query: new URLSearchParams(window.location.search).get('q') || '',

            search() {
                if (this.query.length >= 2) {
                    const url = new URL(window.location);
                    url.searchParams.set('q', this.query);
                    url.searchParams.set('page', '1');
                    window.location.href = url.toString();
                }
            }
        }
    }

    function searchResults() {
        return {
            loading: false,
            query: '',
            results: [],
            facets: {},
            activeFilter: null,
            currentPage: 1,
            totalPages: 1,
            totalResults: 0,
            hasNext: false,
            hasPrev: false,
            performanceMs: null,

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.query = urlParams.get('q') || '';
                this.currentPage = parseInt(urlParams.get('page') || '1');
                this.activeFilter = urlParams.get('category') || null;

                if (this.query) {
                    this.fetchResults();
                }
            },

            async fetchResults() {
                this.loading = true;

                const params = new URLSearchParams({
                    q: this.query,
                    page: this.currentPage,
                    per_page: 20
                });

                if (this.activeFilter) {
                    params.set('category', this.activeFilter);
                }

                try {
                    const response = await fetch(`/api/search/?${params}`);
                    const data = await response.json();

                    if (data.success) {
                        this.results = data.results;
                        this.facets = data.facets.search_category || {};
                        this.totalResults = data.pagination.total_results;
                        this.totalPages = data.pagination.total_pages;
                        this.hasNext = data.pagination.has_next;
                        this.hasPrev = data.pagination.has_prev;
                        this.performanceMs = data.performance.total_ms.toFixed(2);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.results = [];
                } finally {
                    this.loading = false;
                }
            },

            filterByCategory(category) {
                this.activeFilter = category;
                this.currentPage = 1;
                this.updateURL();
                this.fetchResults();
            },

            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                    this.updateURL();
                    this.fetchResults();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            },

            updateURL() {
                const url = new URL(window.location);
                url.searchParams.set('q', this.query);
                url.searchParams.set('page', this.currentPage);

                if (this.activeFilter) {
                    url.searchParams.set('category', this.activeFilter);
                } else {
                    url.searchParams.delete('category');
                }

                window.history.pushState({}, '', url);
            },

            get visiblePages() {
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
                let end = Math.min(this.totalPages, start + maxVisible - 1);

                if (end - start < maxVisible - 1) {
                    start = Math.max(1, end - maxVisible + 1);
                }

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            hasMetadata(result) {
                return result.metadata && Object.keys(result.metadata).length > 0;
            }
        }
    }
</script>
{% endblock %}
