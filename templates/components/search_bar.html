<!-- Global Search Bar Component
     Include in base.html header or navigation
     Usage: {% include "components/search_bar.html" %}
-->

<div x-data="globalSearch()" class="search-bar-container">
    <div class="search-bar-wrapper">
        <!-- Search Input -->
        <div class="search-input-group">
            <input
                type="text"
                class="search-input"
                placeholder="Search..."
                x-model="query"
                @input.debounce.300ms="fetchSuggestions()"
                @keydown.enter="submitSearch()"
                @keydown.down.prevent="navigateSuggestions(1)"
                @keydown.up.prevent="navigateSuggestions(-1)"
                @keydown.escape="closeSuggestions()"
                @focus="showSuggestions = true"
                @blur.debounce.200ms="closeSuggestions()"
            >
            <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>

        <!-- Suggestions Dropdown -->
        <div
            class="search-suggestions"
            x-show="showSuggestions && suggestions.length > 0"
            @click.away="closeSuggestions()"
        >
            <template x-for="(suggestion, index) in suggestions" :key="index">
                <a
                    :href="suggestion.url || `/search/results/?q=${encodeURIComponent(suggestion.text)}`"
                    class="suggestion-item"
                    :class="{ 'active': selectedIndex === index }"
                    @mouseenter="selectedIndex = index"
                >
                    <span class="suggestion-icon" x-text="getCategoryIcon(suggestion.category)"></span>
                    <span class="suggestion-text" x-text="suggestion.text"></span>
                    <span class="suggestion-category" x-text="suggestion.category"></span>
                </a>
            </template>
        </div>
    </div>
</div>

<style>
    .search-bar-container {
        position: relative;
        width: 100%;
        max-width: 500px;
    }

    .search-bar-wrapper {
        position: relative;
    }

    .search-input-group {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 3rem 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: all 0.2s;
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        max-height: 400px;
        overflow-y: auto;
        z-index: 50;
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        text-decoration: none;
        color: #111827;
        transition: background 0.15s;
        cursor: pointer;
    }

    .suggestion-item:hover,
    .suggestion-item.active {
        background: #f3f4f6;
    }

    .suggestion-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .suggestion-text {
        flex: 1;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .suggestion-category {
        font-size: 0.75rem;
        color: #6b7280;
        flex-shrink: 0;
    }

    @media (max-width: 640px) {
        .search-bar-container {
            max-width: 100%;
        }
    }
</style>

<script>
    function globalSearch() {
        return {
            query: '',
            suggestions: [],
            showSuggestions: false,
            selectedIndex: -1,

            async fetchSuggestions() {
                if (this.query.length < 2) {
                    this.suggestions = [];
                    this.showSuggestions = false;
                    return;
                }

                try {
                    const response = await fetch(`/api/search/suggest/?q=${encodeURIComponent(this.query)}&limit=5`);
                    const data = await response.json();

                    if (data.success) {
                        this.suggestions = data.suggestions;
                        this.showSuggestions = this.suggestions.length > 0;
                        this.selectedIndex = -1;
                    }
                } catch (error) {
                    console.error('Suggestions error:', error);
                }
            },

            submitSearch() {
                if (this.query.length >= 2) {
                    if (this.selectedIndex >= 0 && this.suggestions[this.selectedIndex]) {
                        const suggestion = this.suggestions[this.selectedIndex];
                        window.location.href = suggestion.url || `/search/results/?q=${encodeURIComponent(suggestion.text)}`;
                    } else {
                        window.location.href = `/search/results/?q=${encodeURIComponent(this.query)}`;
                    }
                }
            },

            navigateSuggestions(direction) {
                if (!this.showSuggestions || this.suggestions.length === 0) return;

                this.selectedIndex += direction;

                if (this.selectedIndex < -1) {
                    this.selectedIndex = this.suggestions.length - 1;
                } else if (this.selectedIndex >= this.suggestions.length) {
                    this.selectedIndex = -1;
                }
            },

            closeSuggestions() {
                this.showSuggestions = false;
                this.selectedIndex = -1;
            },

            getCategoryIcon(category) {
                const icons = {
                    'Blog Posts': 'üìù',
                    'AI Tools': 'ü§ñ',
                    'Tools': 'üîß',
                    'Useful Resources': 'üîó',
                    'Cybersecurity': 'üîí',
                    'Personal Info': 'üë§',
                    'Social Links': 'üîó'
                };
                return icons[category] || 'üìÑ';
            }
        }
    }
</script>
