{% extends "base/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "CodePlay Editor" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/playground.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900">

  <!-- Editor Header -->
  <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 sticky top-16 z-40">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">

        <!-- Language Selector -->
        <div class="flex items-center space-x-4">
          <select id="languageSelect"
                  class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-yellow-500">
            {% for language in languages %}
            <option value="{{ language.id }}"
                    {% if language.id == selected_language.id %}selected{% endif %}
                    data-extension="{{ language.extension }}">
              {{ language.icon }} {{ language.name }}
            </option>
            {% endfor %}
          </select>

          <!-- Template Selector -->
          <select id="templateSelect"
                  class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-yellow-500">
            <option value="">{% trans "Şablon Seç" %}</option>
            {% for template in templates %}
            <option value="{{ template.id }}" data-code="{{ template.code }}">
              {{ template.emoji }} {{ template.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center space-x-3">
          <button id="runBtn"
                  class="flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m6-9v2.5A2.5 2.5 0 0117.5 10H17"></path>
            </svg>
            {% trans "Çalıştır" %}
            <span class="ml-2 text-xs opacity-75">(Ctrl+Enter)</span>
          </button>

          <button id="saveBtn"
                  class="flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
            {% trans "Kaydet" %}
          </button>

          <button id="shareBtn"
                  class="flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
            </svg>
            {% trans "Paylaş" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Editor Layout -->
  <div class="flex h-[calc(100vh-120px)]">

    <!-- Code Editor Panel -->
    <div class="flex-1 flex flex-col">
      <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 px-4 py-2">
        <div class="flex items-center justify-between">
          <h3 class="text-white font-semibold">{% trans "Kod Editörü" %}</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <span id="lineCount">1 line</span>
            <span>•</span>
            <span id="charCount">0 chars</span>
          </div>
        </div>
      </div>

      <div class="flex-1 relative">
        <textarea id="codeEditor"
                  class="w-full h-full bg-transparent border-none outline-none resize-none"
                  placeholder="// Kod yazmaya başla...&#10;// Ctrl+Enter ile çalıştır"></textarea>
      </div>
    </div>

    <!-- Output Panel -->
    <div class="w-1/2 border-l border-white/10 flex flex-col">
      <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 px-4 py-2">
        <div class="flex items-center justify-between">
          <h3 class="text-white font-semibold">{% trans "Çıktı" %}</h3>
          <div class="flex items-center space-x-2">
            <span id="executionTime" class="text-xs text-gray-400"></span>
            <button id="clearOutput"
                    class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="flex-1 bg-black/10 p-4 overflow-auto">
        <div id="outputContent" class="text-green-400 font-mono text-sm whitespace-pre-wrap">
          {% trans "Kod çalıştırıldığında sonuçlar burada görünecek..." %}
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay"
       class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-2 border-yellow-500 border-t-transparent mx-auto mb-4"></div>
      <p class="text-white font-semibold">{% trans "Kod çalışıyor..." %}</p>
    </div>
  </div>

  <!-- Save Modal -->
  <div id="saveModal"
       class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-white font-bold text-xl mb-4">{% trans "Kodu Kaydet" %}</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-white text-sm font-medium mb-2">{% trans "Başlık" %}</label>
          <input type="text" id="snippetTitle"
                 class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-yellow-500"
                 placeholder="{% trans 'Kod parçası için bir başlık...' %}">
        </div>

        <div class="flex items-center">
          <input type="checkbox" id="isPublic"
                 class="w-4 h-4 text-yellow-500 bg-white/10 border-white/20 rounded focus:ring-yellow-500">
          <label for="isPublic" class="ml-2 text-white text-sm">
            {% trans "Herkese açık yap (galerede görünsün)" %}
          </label>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button id="cancelSave"
                class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
          {% trans "İptal" %}
        </button>
        <button id="confirmSave"
                class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:scale-105 transition-all">
          {% trans "Kaydet" %}
        </button>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>

<script>
let editor;
let currentLanguageId = {{ selected_language.id }};

document.addEventListener('DOMContentLoaded', function() {
  // Initialize CodeMirror
  editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
    theme: 'monokai',
    lineNumbers: true,
    mode: getLanguageMode({{ selected_language.id }}),
    indentUnit: 2,
    lineWrapping: true,
    autofocus: true
  });

  // Set initial code if template is provided
  const urlParams = new URLSearchParams(window.location.search);
  const templateId = urlParams.get('template');
  if (templateId) {
    loadTemplateById(templateId);
  }

  // Event Listeners
  document.getElementById('languageSelect').addEventListener('change', function() {
    currentLanguageId = parseInt(this.value);
    const selectedOption = this.options[this.selectedIndex];
    editor.setOption('mode', getLanguageModeByName(selectedOption.text));
    loadTemplatesForLanguage(currentLanguageId);
  });

  document.getElementById('templateSelect').addEventListener('change', function() {
    if (this.value) {
      loadTemplateById(this.value);
    }
  });

  document.getElementById('runBtn').addEventListener('click', runCode);
  document.getElementById('saveBtn').addEventListener('click', showSaveModal);
  document.getElementById('shareBtn').addEventListener('click', shareCode);
  document.getElementById('clearOutput').addEventListener('click', clearOutput);

  // Save modal handlers
  document.getElementById('cancelSave').addEventListener('click', hideSaveModal);
  document.getElementById('confirmSave').addEventListener('click', saveCode);

  // Keyboard shortcuts
  editor.setOption('extraKeys', {
    'Ctrl-Enter': runCode,
    'Ctrl-S': function() {
      showSaveModal();
      return false;
    }
  });

  // Update stats
  editor.on('change', updateStats);
  updateStats();
});

function getLanguageMode(languageId) {
  const languageSelect = document.getElementById('languageSelect');
  const option = languageSelect.querySelector(`option[value="${languageId}"]`);
  return getLanguageModeByName(option ? option.text : 'JavaScript');
}

function getLanguageModeByName(languageName) {
  const name = languageName.toLowerCase();
  if (name.includes('python')) return 'python';
  if (name.includes('javascript')) return 'javascript';
  if (name.includes('c++')) return 'text/x-c++src';
  if (name.includes('c#')) return 'text/x-csharp';
  if (name.includes('c')) return 'text/x-csrc';
  return 'javascript';
}

function updateStats() {
  const code = editor.getValue();
  const lines = code.split('\n').length;
  const chars = code.length;

  document.getElementById('lineCount').textContent = `${lines} line${lines !== 1 ? 's' : ''}`;
  document.getElementById('charCount').textContent = `${chars} chars`;
}

function runCode() {
  const code = editor.getValue().trim();
  if (!code) {
    showError('{% trans "Lütfen çalıştırılacak kod yazın" %}');
    return;
  }

  showLoading(true);

  fetch('{% url "playground:execute_code" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      code: code,
      language_id: currentLanguageId
    })
  })
  .then(response => response.json())
  .then(data => {
    showLoading(false);
    displayOutput(data);
  })
  .catch(error => {
    showLoading(false);
    showError('{% trans "Kod çalıştırılırken hata oluştu" %}: ' + error.message);
  });
}

function displayOutput(result) {
  const outputContent = document.getElementById('outputContent');
  const executionTime = document.getElementById('executionTime');

  if (result.success) {
    outputContent.innerHTML = `<div class="text-green-400">${escapeHtml(result.output)}</div>`;
  } else {
    outputContent.innerHTML = `<div class="text-red-400">${escapeHtml(result.error)}</div>`;
  }

  if (result.execution_time) {
    executionTime.textContent = `${result.execution_time.toFixed(2)}ms`;
  }
}

function showError(message) {
  const outputContent = document.getElementById('outputContent');
  outputContent.innerHTML = `<div class="text-red-400">❌ ${escapeHtml(message)}</div>`;
}

function clearOutput() {
  document.getElementById('outputContent').textContent = '{% trans "Kod çalıştırıldığında sonuçlar burada görünecek..." %}';
  document.getElementById('executionTime').textContent = '';
}

function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.toggle('hidden', !show);
  overlay.classList.toggle('flex', show);
}

function showSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.getElementById('snippetTitle').focus();
}

function hideSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function saveCode() {
  const code = editor.getValue().trim();
  if (!code) {
    showError('{% trans "Boş kod kaydedilemez" %}');
    return;
  }

  const title = document.getElementById('snippetTitle').value;
  const isPublic = document.getElementById('isPublic').checked;
  const output = document.getElementById('outputContent').textContent;

  fetch('{% url "playground:save_snippet" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      title: title,
      code: code,
      output: output,
      language_id: currentLanguageId,
      is_public: isPublic
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      hideSaveModal();
      showNotification('{% trans "Kod başarıyla kaydedildi!" %}', 'success');

      // Update URL to share link
      const shareUrl = window.location.origin + data.share_url;
      navigator.clipboard.writeText(shareUrl).then(() => {
        showNotification('{% trans "Paylaşım linki panoya kopyalandı!" %}', 'info');
      });
    } else {
      showError('{% trans "Kaydetme hatası" %}: ' + data.error);
    }
  })
  .catch(error => {
    showError('{% trans "Kaydetme hatası" %}: ' + error.message);
  });
}

function shareCode() {
  saveCode(); // Save first, then share
}

function loadTemplateById(templateId) {
  fetch(`{% url "playground:get_template" 0 %}`.replace('0', templateId))
  .then(response => response.json())
  .then(data => {
    editor.setValue(data.code);
    if (data.language_id !== currentLanguageId) {
      document.getElementById('languageSelect').value = data.language_id;
      currentLanguageId = data.language_id;
      editor.setOption('mode', getLanguageMode(data.language_id));
    }
  })
  .catch(error => {
    showError('{% trans "Şablon yüklenemedi" %}: ' + error.message);
  });
}

function loadTemplatesForLanguage(languageId) {
  // This would need backend support to filter templates by language
  // For now, just reload the page with the new language
  window.location.href = `{% url "playground:editor_language" 0 %}`.replace('0', languageId);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showNotification(message, type = 'success') {
  // Simple notification system
  const notification = document.createElement('div');
  notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold transition-all duration-300 transform translate-x-full ${
    type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
  }`;
  notification.textContent = message;

  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);

  setTimeout(() => {
    notification.style.transform = 'translateX(full)';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}
</script>
{% endblock %}