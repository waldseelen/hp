{% extends "base/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "CodePlay Editor" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/playground.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900">
  <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 sticky top-16 z-40">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <select id="languageSelect" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-yellow-500">
            {% for language in languages %}
            <option value="{{ language.id }}" {% if language.id == selected_language.id %}selected{% endif %} data-extension="{{ language.extension }}">
              {{ language.icon }} {{ language.name }}
            </option>
            {% endfor %}
          </select>

          <select id="templateSelect" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-yellow-500">
            <option value="">{% trans 'Choose template' %}</option>
            {% for template in templates %}
            <option value="{{ template.id }}" data-code="{{ template.code }}">
              {{ template.emoji }} {{ template.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="flex items-center space-x-3">
          <button id="runBtn" class="flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m6-9v2.5A2.5 2.5 0 0117.5 10H17"/>
            </svg>
            {% trans 'Run' %}
            <span class="ml-2 text-xs opacity-75">(Ctrl+Enter)</span>
          </button>

          <button id="saveBtn" class="flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
            </svg>
            {% trans 'Save' %}
          </button>

          <button id="shareBtn" class="flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold rounded-lg transition-all duration-300 hover:scale-105">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
            </svg>
            {% trans 'Share' %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex h-[calc(100vh-120px)]">
    <div class="flex-1 flex flex-col">
      <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 px-4 py-2">
        <div class="flex items-center justify-between">
          <h3 class="text-white font-semibold">{% trans 'Code editor' %}</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <span id="lineCount">1 line</span>
            <span>•</span>
            <span id="charCount">0 chars</span>
          </div>
        </div>
      </div>

      <div class="flex-1 relative">
        <textarea id="codeEditor" class="w-full h-full bg-transparent border-none outline-none resize-none" placeholder="// Start coding...&#10;// Press Ctrl+Enter to run"></textarea>
      </div>
    </div>

    <div class="w-1/2 border-l border-white/10 flex flex-col">
      <div class="bg-black/20 backdrop-blur-xl border-b border-white/10 px-4 py-2">
        <div class="flex items-center justify-between">
          <h3 class="text-white font-semibold">{% trans 'Output' %}</h3>
          <button id="clearOutputBtn" class="text-sm text-gray-400 hover:text-white transition-colors">{% trans 'Clear output' %}</button>
        </div>
      </div>

      <div id="outputArea" class="flex-1 bg-black/40 text-green-300 font-mono text-sm p-4 overflow-auto">
        <pre id="outputContent">{% trans 'Results will appear here when you run your code...' %}</pre>
        <div id="executionTime" class="text-gray-500 text-xs mt-4"></div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-white text-lg">{% trans 'Running your code...' %}</p>
    </div>
  </div>

  <div id="saveModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-lg z-50 items-center justify-center">
    <div class="bg-gray-900 border border-white/10 rounded-2xl p-8 shadow-2xl w-full max-w-lg">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white">{% trans 'Save snippet' %}</h2>
        <button onclick="hideSaveModal()" class="text-gray-400 hover:text-white transition-colors">×</button>
      </div>

      <label class="block text-sm text-gray-300 mb-2" for="snippetTitle">{% trans 'Title' %}</label>
      <input type="text" id="snippetTitle" class="w-full px-4 py-3 bg-black/40 border border-white/10 rounded-lg text-white mb-4 focus:outline-none focus:border-primary-400" placeholder="{% trans 'Give your snippet a name' %}">

      <div class="flex items-center justify-between mb-6">
        <label class="flex items-center space-x-3 text-sm text-gray-300" for="isPublic">
          <input type="checkbox" id="isPublic" class="w-4 h-4 text-primary-500 focus:ring-primary-400">
          <span>{% trans 'Make snippet public' %}</span>
        </label>
        <span class="text-xs text-gray-500">{% trans 'Public snippets appear in the gallery.' %}</span>
      </div>

      <div class="flex items-center justify-end space-x-3">
        <button type="button" onclick="hideSaveModal()" class="btn btn--ghost">{% trans 'Cancel' %}</button>
        <button type="button" onclick="saveCode()" class="btn btn--primary">{% trans 'Save snippet' %}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/scroll/simplescrollbars.min.js"></script>

<script>
// existing JS same but update strings
const outputContent = document.getElementById('outputContent');
const executionTime = document.getElementById('executionTime');
const languageSelect = document.getElementById('languageSelect');
const templateSelect = document.getElementById('templateSelect');
const runBtn = document.getElementById('runBtn');
const saveBtn = document.getElementById('saveBtn');
const shareBtn = document.getElementById('shareBtn');
const clearOutputBtn = document.getElementById('clearOutputBtn');
const lineCount = document.getElementById('lineCount');
const charCount = document.getElementById('charCount');
let currentLanguageId = {{ selected_language.id|default:"null" }};

const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
  lineNumbers: true,
  theme: 'monokai',
  mode: getLanguageMode(currentLanguageId),
  scrollbarStyle: 'simple',
  autoCloseBrackets: true,
  matchBrackets: true,
  indentUnit: 2,
  tabSize: 2,
  indentWithTabs: false
});

document.addEventListener('keydown', (event) => {
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    runCode();
  }
});

editor.on('change', () => {
  const value = editor.getValue();
  const lines = value.split('\n').length;
  const chars = value.length;
  lineCount.textContent = lines === 1 ? '1 line' : ${lines} lines;
  charCount.textContent = ${chars} chars;
});

runBtn.addEventListener('click', runCode);
saveBtn.addEventListener('click', showSaveModal);
shareBtn.addEventListener('click', shareCode);
clearOutputBtn.addEventListener('click', clearOutput);
languageSelect.addEventListener('change', handleLanguageChange);
templateSelect.addEventListener('change', handleTemplateChange);

const initialCode = {{ initial_code|default:""|escapejs }};
if (initialCode) {
  editor.setValue(initialCode);
}

function handleLanguageChange(event) {
  const languageId = event.target.value;
  currentLanguageId = languageId;
  editor.setOption('mode', getLanguageMode(languageId));
  loadTemplatesForLanguage(languageId);
}

function handleTemplateChange(event) {
  const selectedOption = event.target.selectedOptions[0];
  const code = selectedOption.dataset.code;
  if (code) {
    editor.setValue(code);
    editor.focus();
  }
}

function getLanguageMode(languageId) {
  const option = languageSelect.querySelector(option[value=""]);
  if (!option) return 'python';
  const extension = option.dataset.extension;
  switch (extension) {
    case 'py': return 'python';
    case 'js': return 'javascript';
    case 'ts': return 'text/typescript';
    case 'go': return 'go';
    case 'rs': return 'text/x-rustsrc';
    case 'sh': return 'shell';
    case 'cpp': return 'text/x-c++src';
    case 'java': return 'text/x-java';
    default: return 'python';
  }
}

function runCode() {
  const code = editor.getValue();
  if (!code.trim()) {
    showError('{% trans "Please write some code before running." %}');
    return;
  }
  showLoading(true);
  clearOutput();

  const requestData = {
    language_id: currentLanguageId,
    code: code,
  };

  fetch('{% url "playground:run_code" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        let output = data.output;
        if (data.error_output) {
          output += \n;
        }
        showOutput(output, data.execution_time);
      } else {
        showError(data.error || '{% trans "An unexpected error occurred." %}');
      }
    })
    .catch(error => {
      showError('{% trans "Run failed" %}: ' + error.message);
    })
    .finally(() => {
      showLoading(false);
    });
}

function showOutput(output, time) {
  outputContent.textContent = output;
  executionTime.textContent = time ? {% trans "Completed in" %}  ms : '';
}

function showError(message) {
  outputContent.innerHTML = <div class="text-red-400">⚠️ </div>;
}

function clearOutput() {
  outputContent.textContent = '{% trans "Results will appear here when you run your code..." %}';
  executionTime.textContent = '';
}

function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.toggle('hidden', !show);
  overlay.classList.toggle('flex', show);
}

function showSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.getElementById('snippetTitle').focus();
}

function hideSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function saveCode() {
  const code = editor.getValue().trim();
  if (!code) {
    showError('{% trans "Cannot save an empty snippet." %}');
    return;
  }

  const title = document.getElementById('snippetTitle').value;
  const isPublic = document.getElementById('isPublic').checked;
  const output = outputContent.textContent;

  fetch('{% url "playground:save_snippet" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      title: title,
      code: code,
      output: output,
      language_id: currentLanguageId,
      is_public: isPublic
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        hideSaveModal();
        showNotification('{% trans "Snippet saved successfully." %}', 'success');
        const shareUrl = window.location.origin + data.share_url;
        navigator.clipboard.writeText(shareUrl).then(() => {
          showNotification('{% trans "Share link copied to clipboard." %}', 'info');
        });
      } else {
        showError('{% trans "Save failed" %}: ' + data.error);
      }
    })
    .catch(error => {
      showError('{% trans "Save failed" %}: ' + error.message);
    });
}

function shareCode() {
  saveCode();
}

function loadTemplateById(templateId) {
  fetch({% url "playground:get_template" 0 %}.replace('0', templateId))
    .then(response => response.json())
    .then(data => {
      editor.setValue(data.code);
      if (data.language_id !== currentLanguageId) {
        languageSelect.value = data.language_id;
        currentLanguageId = data.language_id;
        editor.setOption('mode', getLanguageMode(data.language_id));
      }
    })
    .catch(error => {
      showError('{% trans "Template could not be loaded" %}: ' + error.message);
    });
}

function loadTemplatesForLanguage(languageId) {
  window.location.href = {% url "playground:editor_language" 0 %}.replace('0', languageId);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = ixed top-20 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold transition-all duration-300 transform translate-x-full ;
  notification.textContent = message;
  document.body.appendChild(notification);
  requestAnimationFrame(() => {
    notification.style.transform = 'translateX(0)';
  });
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>
{% endblock %}
