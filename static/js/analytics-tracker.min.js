class AnalyticsTracker{constructor(){this.journeyId=null,this.abTests={},this.funnelData={},this.initialized=!1,this.csrfToken=this.getCsrfToken(),this.init()}init(){this.initialized||(this.trackPageView(),this.trackJourneyStep(this.getPageName()),this.setupEventListeners(),this.loadAbTests(),this.initialized=!0)}getCsrfToken(){const t=document.querySelector('meta[name="csrf-token"]');if(t)return t.getAttribute("content");const e=document.querySelector("[name=csrfmiddlewaretoken]");if(e)return e.value;const n=document.cookie.split(";");for(let t of n){const[e,n]=t.trim().split("=");if("csrftoken"===e)return decodeURIComponent(n)}return null}async sendRequest(t,e=null,n="POST"){const a={method:n,headers:{"Content-Type":"application/json"},credentials:"same-origin"};this.csrfToken&&"GET"!==n&&(a.headers["X-CSRFToken"]=this.csrfToken),e&&"GET"!==n&&(a.body=JSON.stringify(e));try{const e=await fetch(t,a);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(t){return console.error("Analytics request failed:",t),null}}trackPageView(){const t={page_path:window.location.pathname,page_title:document.title,referrer:document.referrer};this.sendRequest("/api/analytics/event/",{event_name:"page_view",event_data:t})}trackEvent(t,e={}){this.sendRequest("/api/analytics/event/",{event_name:t,event_data:e})}trackConversion(t,e=null){this.sendRequest("/api/analytics/conversion/",{conversion_type:t,conversion_value:e}),Object.keys(this.abTests).forEach(e=>{this.trackAbConversion(e,t)})}async trackJourneyStep(t){const e=await this.sendRequest("/api/analytics/journey/",{step_name:t,journey_id:this.journeyId});e&&e.journey_id&&(this.journeyId=e.journey_id)}async trackFunnelStep(t,e,n){await this.sendRequest("/api/analytics/funnel/",{funnel_name:t,step_name:e,step_order:n}),this.funnelData[t]={current_step:e,step_order:n}}async getAbVariant(t,e=null){const n=new URLSearchParams({test_name:t});e&&e.forEach(t=>n.append("variants",t));const a=await this.sendRequest(`/api/analytics/ab/variant/?${n.toString()}`,null,"GET");return a&&a.variant?(this.abTests[t]=a.variant,a.variant):"A"}async trackAbConversion(t,e="conversion"){this.abTests[t]&&await this.sendRequest("/api/analytics/ab/conversion/",{test_name:t,conversion_type:e})}setupEventListeners(){document.addEventListener("click",t=>{const e=t.target.closest("[data-track-click]");if(e){const t=e.dataset.trackClick,n=this.getDataAttributes(e,"track");this.trackEvent(`click_${t}`,n)}const n=t.target.closest("[data-track-conversion]");if(n){const t=n.dataset.trackConversion,e=n.dataset.conversionValue;this.trackConversion(t,e)}}),document.addEventListener("submit",t=>{const e=t.target;if(e.dataset.trackSubmit){const t=e.dataset.trackSubmit,n=this.getDataAttributes(e,"track");this.trackEvent(`submit_${t}`,n)}if(e.dataset.funnel){const t=e.dataset.funnel,n=e.dataset.funnelStep,a=parseInt(e.dataset.funnelOrder||"1");this.trackFunnelStep(t,n,a)}});let t=0,e=null;window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{const e=Math.round((window.scrollY+window.innerHeight)/document.documentElement.scrollHeight*100);e>t&&(t=e,e>=25&&t<25?this.trackEvent("scroll_depth",{depth:25}):e>=50&&t<50?this.trackEvent("scroll_depth",{depth:50}):e>=75&&t<75?this.trackEvent("scroll_depth",{depth:75}):e>=90&&t<90&&this.trackEvent("scroll_depth",{depth:90}))},500)});let n=Date.now();window.addEventListener("beforeunload",()=>{const t=Math.round((Date.now()-n)/1e3);if(t>3){const e=new FormData;e.append("csrfmiddlewaretoken",this.csrfToken),e.append("data",JSON.stringify({event_name:"time_on_page",event_data:{seconds:t,page:window.location.pathname}})),navigator.sendBeacon("/api/analytics/event/",e)}})}getDataAttributes(t,e){const n={};for(let a of t.attributes)if(a.name.startsWith(`data-${e}-`)&&!a.name.endsWith("-click")&&!a.name.endsWith("-submit")&&!a.name.endsWith("-conversion")){n[a.name.replace(`data-${e}-`,"").replace(/-/g,"_")]=a.value}return n}getPageName(){const t=window.location.pathname;if("/"===t)return"home";return t.split("/").filter(t=>t).join("_")||"unknown"}async loadAbTests(){const t=document.querySelectorAll("[data-ab-test]");for(let e of t){const t=e.dataset.abTest,n=e.dataset.abVariants?e.dataset.abVariants.split(","):null,a=await this.getAbVariant(t,n);e.classList.add(`variant-${a.toLowerCase()}`),e.dataset.abVariant=a,document.querySelectorAll(`[data-ab-show="${t}"]`).forEach(t=>{t.dataset.abVariant===a?t.style.display="":t.style.display="none"})}}startSignupFunnel(){this.trackFunnelStep("signup","view_form",1)}continueSignupFunnel(t){const e={email_entered:2,details_filled:3,submitted:4};e[t]&&this.trackFunnelStep("signup",t,e[t])}startContactFunnel(){this.trackFunnelStep("contact","view_form",1)}continueContactFunnel(t){const e={form_started:2,form_filled:3,submitted:4};e[t]&&this.trackFunnelStep("contact",t,e[t])}}let analyticsTracker;function optOutAnalytics(){document.cookie="analytics_opt_out=true; max-age=31536000; path=/",window.analyticsTracker&&(window.analyticsTracker=null)}function optInAnalytics(){document.cookie="analytics_opt_out=; max-age=0; path=/",window.analyticsTracker||(window.analyticsTracker=new AnalyticsTracker)}document.addEventListener("DOMContentLoaded",()=>{document.cookie.includes("analytics_opt_out=true")||(analyticsTracker=new AnalyticsTracker,window.analyticsTracker=analyticsTracker)});
//# sourceMappingURL=analytics-tracker.min.js.map
