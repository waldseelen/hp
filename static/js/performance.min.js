class PerformanceMonitor { constructor() { this.metrics = { lcp: null, fid: null, cls: null, fcp: null, ttfb: null, domContentLoaded: null, loadComplete: null }, this.observers = new Map, this.networkInfo = null, this.isRecording = !0, this.reportingEndpoint = "/api/performance/", this.init() } init() { this.setupCoreWebVitals(), this.setupResourceMonitoring(), this.setupNetworkMonitoring(), this.setupMemoryMonitoring(), this.setupServiceWorkerIntegration(), "loading" === document.readyState ? document.addEventListener("DOMContentLoaded", () => this.onDOMReady()) : this.onDOMReady(), this.setupReporting() } setupCoreWebVitals() { this.observeLCP(), this.observeFID(), this.observeCLS(), this.observeFCP(), this.measureTTFB() } observeLCP() { if ("PerformanceObserver" in window) try { const e = new PerformanceObserver(e => { const t = e.getEntries(), r = t[t.length - 1]; this.metrics.lcp = Math.round(r.startTime), this.metrics.lcp > 2500 && this.reportMetric("lcp_slow", this.metrics.lcp) }); e.observe({ type: "largest-contentful-paint", buffered: !0 }), this.observers.set("lcp", e) } catch (e) { console.warn("LCP measurement not supported:", e) } } observeFID() { if ("PerformanceObserver" in window) try { const e = new PerformanceObserver(e => { e.getEntries().forEach(e => { this.metrics.fid = Math.round(e.processingStart - e.startTime), this.metrics.fid > 100 && this.reportMetric("fid_slow", this.metrics.fid) }) }); e.observe({ type: "first-input", buffered: !0 }), this.observers.set("fid", e) } catch (e) { console.warn("FID measurement not supported:", e) } } observeCLS() { if ("PerformanceObserver" in window) try { let e = 0, t = []; const r = new PerformanceObserver(r => { r.getEntries().forEach(r => { r.hadRecentInput || (t.push(r), e += r.value) }), this.metrics.cls = Math.round(1e3 * e) / 1e3, this.metrics.cls > .1 && (this.reportMetric("cls_high", this.metrics.cls), this.analyzeCLSCauses(t)) }); r.observe({ type: "layout-shift", buffered: !0 }), this.observers.set("cls", r) } catch (e) { console.warn("CLS measurement not supported:", e) } } observeFCP() { if ("PerformanceObserver" in window) try { const e = new PerformanceObserver(e => { const t = e.getEntries(), r = t[t.length - 1]; this.metrics.fcp = Math.round(r.startTime) }); e.observe({ type: "paint", buffered: !0 }), this.observers.set("fcp", e) } catch (e) { console.warn("FCP measurement not supported:", e) } } measureTTFB() { if ("performance" in window && "getEntriesByType" in performance) { const e = performance.getEntriesByType("navigation")[0]; e && (this.metrics.ttfb = Math.round(e.responseStart - e.requestStart), this.metrics.ttfb > 600 && this.reportMetric("ttfb_slow", this.metrics.ttfb)) } } setupResourceMonitoring() { if ("PerformanceObserver" in window) try { const e = new PerformanceObserver(e => { e.getEntries().forEach(e => { this.analyzeResourcePerformance(e) }) }); e.observe({ type: "resource", buffered: !0 }), this.observers.set("resource", e) } catch (e) { console.warn("Resource monitoring not supported:", e) } } analyzeResourcePerformance(e) { const t = e.responseEnd - e.requestStart, r = e.transferSize || e.decodedBodySize || 0; "img" === e.initiatorType && t > 2e3 && this.reportMetric("slow_image", { url: e.name, duration: Math.round(t), size: r }), "script" === e.initiatorType && t > 3e3 && this.reportMetric("slow_script", { url: e.name, duration: Math.round(t), size: r }), "link" === e.initiatorType && e.name.includes(".css") && t > 2e3 && this.reportMetric("slow_css", { url: e.name, duration: Math.round(t), size: r }), r > 1048576 && this.reportMetric("large_resource", { url: e.name, size: r, type: e.initiatorType }) } setupNetworkMonitoring() { "connection" in navigator && (this.networkInfo = { effectiveType: navigator.connection.effectiveType, downlink: navigator.connection.downlink, rtt: navigator.connection.rtt, saveData: navigator.connection.saveData }, navigator.connection.addEventListener("change", () => { this.onNetworkChange() }), this.adaptToConnection()), window.addEventListener("online", () => this.onNetworkOnline()), window.addEventListener("offline", () => this.onNetworkOffline()) } onNetworkChange() { const e = { effectiveType: navigator.connection.effectiveType, downlink: navigator.connection.downlink, rtt: navigator.connection.rtt, saveData: navigator.connection.saveData }; this.networkInfo.effectiveType !== e.effectiveType && this.reportMetric("network_change", { from: this.networkInfo.effectiveType, to: e.effectiveType }), this.networkInfo = e, this.adaptToConnection() } adaptToConnection() { if (!this.networkInfo) return; const { effectiveType: e, saveData: t } = this.networkInfo; "2g" === e || "slow-2g" === e || t ? this.enableDataSaverMode() : "4g" === e && this.enableHighQualityMode() } enableDataSaverMode() { document.body.classList.add("reduce-motion"); document.querySelectorAll("img[data-src]").forEach(e => { e.dataset.srcLow && (e.dataset.src = e.dataset.srcLow) }); document.querySelectorAll("video[autoplay]").forEach(e => { e.removeAttribute("autoplay"), e.pause() }), this.reportMetric("data_saver_enabled", !0) } enableHighQualityMode() { document.body.classList.remove("reduce-motion"); document.querySelectorAll("img[data-src]").forEach(e => { e.dataset.srcHigh && (e.dataset.src = e.dataset.srcHigh) }), document.body.classList.add("enhanced-animations") } onNetworkOnline() { this.reportMetric("network_online", Date.now()), "serviceWorker" in navigator && navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage({ type: "SYNC_WHEN_ONLINE" }) } onNetworkOffline() { this.reportMetric("network_offline", Date.now()), this.showOfflineIndicator() } setupMemoryMonitoring() { "memory" in performance && setInterval(() => { const e = performance.memory, t = { used: Math.round(e.usedJSHeapSize / 1024 / 1024), total: Math.round(e.totalJSHeapSize / 1024 / 1024), limit: Math.round(e.jsHeapSizeLimit / 1024 / 1024) }; t.used / t.limit > .8 && (this.reportMetric("high_memory_usage", t), this.triggerMemoryCleanup()) }, 3e4) } triggerMemoryCleanup() { this.observers.forEach((e, t) => { "lcp" !== t && "fid" !== t && "cls" !== t && (e.disconnect(), this.observers.delete(t)) }), "caches" in window && caches.keys().then(e => { e.forEach(e => { (e.includes("old") || e.includes("temp")) && caches.delete(e) }) }), window.gc && window.gc() } setupServiceWorkerIntegration() { "serviceWorker" in navigator && navigator.serviceWorker.addEventListener("message", e => { const { type: t, data: r } = e.data; switch (t) { case "CACHE_PERFORMANCE": this.reportMetric("cache_hit_rate", r); break; case "OFFLINE_FALLBACK": this.reportMetric("offline_fallback_used", r); break; case "UPDATE_AVAILABLE": this.handleServiceWorkerUpdate() } }) } handleServiceWorkerUpdate() { window.showToast && window.showToast("A new version is available", "info", { autoDismiss: !1, actions: [{ text: "Reload", handler: () => window.location.reload() }, { text: "Later", handler: () => { } }] }) } onDOMReady() { this.metrics.domContentLoaded = performance.now(), this.setupLazyLoading(), this.optimizeCriticalResources(), this.setupInteractionMonitoring() } setupLazyLoading() { if (window.__imgLazyOwner && "performance" !== window.__imgLazyOwner) return; if (window.__imgLazyInitialized) return; window.__imgLazyOwner = "performance"; window.__imgLazyInitialized = !0; if (!("IntersectionObserver" in window)) { document.querySelectorAll("img[data-src]").forEach(e => { this.loadImage(e) }); document.querySelectorAll("[data-lazy-content]").forEach(e => { this.loadDeferredContent(e) }); return } const e = new IntersectionObserver((e, t) => { e.forEach(e => { if (e.isIntersecting) { const r = e.target; this.loadImage(r), t.unobserve(r) } }) }, { rootMargin: "50px 0px", threshold: .1 }); document.querySelectorAll("img[data-src]").forEach(t => { t.classList.add("lazy"), e.observe(t) }); const t = new IntersectionObserver(e => { e.forEach(e => { if (e.isIntersecting) { const r = e.target; this.loadDeferredContent(r), t.unobserve(r) } }) }, { rootMargin: "100px 0px", threshold: .1 }); document.querySelectorAll("[data-lazy-content]").forEach(e => { t.observe(e) }) } loadImage(e) { const t = performance.now(); let r = e.dataset.src; this.networkInfo?.saveData || "2g" === this.networkInfo?.effectiveType ? r = e.dataset.srcLow || r : window.devicePixelRatio > 2 && (r = e.dataset.srcHigh || r); const o = new Image; o.onload = () => { const o = performance.now() - t; e.src = r, e.classList.remove("lazy"), e.classList.add("loaded"), e.getAttribute("data-original-html") || e.setAttribute("data-original-html", e.outerHTML), o > 2e3 && this.reportMetric("slow_image_load", { src: r, loadTime: Math.round(o) }) }, o.onerror = () => { e.classList.add("error"), e.src = e.dataset.fallback || "/static/images/placeholder.svg", this.reportMetric("image_load_error", { src: r, fallback: e.dataset.fallback }) }, o.src = r } loadDeferredContent(e) { switch (e.dataset.lazyContent) { case "widget": this.loadWidget(e); break; case "chart": this.loadChart(e); break; case "social": this.loadSocialEmbed(e); break; default: this.loadGenericContent(e) } } optimizeCriticalResources() { this.preloadCriticalResources(), this.optimizeFonts(), this.optimizeThirdPartyScripts() } preloadCriticalResources() { [{ href: "/static/css/components.css", as: "style" }, { href: "/static/js/ui-enhancements.js", as: "script" }].forEach(e => { const t = document.createElement("link"); t.rel = "preload", t.href = e.href, t.as = e.as, "script" === e.as && (t.crossOrigin = "anonymous"), document.head.appendChild(t) }) } optimizeFonts() { document.querySelectorAll('link[rel="stylesheet"][href*="fonts"]');[].forEach(e => { const t = document.createElement("link"); t.rel = "preload", t.href = e, t.as = "font", t.type = "font/woff2", t.crossOrigin = "anonymous", document.head.appendChild(t) }) } optimizeThirdPartyScripts() { document.querySelectorAll("script[data-defer]").forEach(e => { "interaction" === e.dataset.defer ? this.loadOnInteraction(e) : "idle" === e.dataset.defer && this.loadOnIdle(e) }) } loadOnInteraction(e) { const t = ["mousedown", "touchstart", "keydown", "scroll"], r = () => { e.src = e.dataset.src, t.forEach(e => { document.removeEventListener(e, r, { passive: !0 }) }) }; t.forEach(e => { document.addEventListener(e, r, { passive: !0 }) }) } loadOnIdle(e) { "requestIdleCallback" in window ? requestIdleCallback(() => { e.src = e.dataset.src }) : setTimeout(() => { e.src = e.dataset.src }, 2e3) } setupInteractionMonitoring() { ["click", "scroll", "keydown", "mousemove"].forEach(e => { document.addEventListener(e, e => { this.measureInteractionPerformance(e) }, { passive: !0 }) }) } measureInteractionPerformance(e) { const t = performance.now(); requestAnimationFrame(() => { const r = performance.now() - t; r > 100 && this.reportMetric("slow_interaction", { type: e.type, responseTime: Math.round(r), target: e.target.tagName.toLowerCase() }) }) } setupReporting() { setInterval(() => { this.reportCurrentMetrics() }, 3e4), window.addEventListener("beforeunload", () => { this.reportFinalMetrics() }), document.addEventListener("visibilitychange", () => { "hidden" === document.visibilityState && this.reportFinalMetrics() }) } reportMetric(e, t) { if (!this.isRecording) return; const r = { name: e, value: t, timestamp: Date.now(), url: window.location.href, userAgent: navigator.userAgent, networkInfo: this.networkInfo, viewport: { width: window.innerWidth, height: window.innerHeight } }; this.sendMetric(r), "localhost" === window.location.hostname || window.location.hostname } sendMetric(e) { const t = this.getCSRFToken(); if (navigator.sendBeacon && t) { const r = new FormData; r.append("csrfmiddlewaretoken", t), r.append("data", JSON.stringify(e)), navigator.sendBeacon(this.reportingEndpoint, r) } else fetch(this.reportingEndpoint, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": t || "", "X-Requested-With": "XMLHttpRequest" }, body: JSON.stringify(e) }).catch(e => { console.warn("Failed to send performance metric:", e) }) } getCSRFToken() { const e = document.querySelector('meta[name="csrf-token"]'); if (e) return e.getAttribute("content"); const t = document.cookie.match(/csrftoken=([^;]+)/); if (t) return t[1]; const r = document.querySelector('input[name="csrfmiddlewaretoken"]'); return r ? r.value : null } reportCurrentMetrics() { Object.values(this.metrics).some(e => null !== e) && this.reportMetric("core_vitals", { ...this.metrics }) } reportFinalMetrics() { this.metrics.loadComplete = performance.now(), this.reportMetric("page_complete", { metrics: this.metrics, timing: this.getNavigationTiming(), resources: this.getResourceSummary() }) } getNavigationTiming() { if ("performance" in window && "getEntriesByType" in performance) { const e = performance.getEntriesByType("navigation")[0]; if (e) return { dns: Math.round(e.domainLookupEnd - e.domainLookupStart), connection: Math.round(e.connectEnd - e.connectStart), request: Math.round(e.responseStart - e.requestStart), response: Math.round(e.responseEnd - e.responseStart), dom: Math.round(e.domContentLoadedEventEnd - e.domContentLoadedEventStart), load: Math.round(e.loadEventEnd - e.loadEventStart) } } return null } getResourceSummary() { if ("performance" in window && "getEntriesByType" in performance) { const e = performance.getEntriesByType("resource"), t = { total: e.length, scripts: 0, styles: 0, images: 0, fonts: 0, other: 0, totalSize: 0 }; return e.forEach(e => { const r = e.transferSize || e.decodedBodySize || 0; switch (t.totalSize += r, e.initiatorType) { case "script": t.scripts++; break; case "link": e.name.includes(".css") ? t.styles++ : t.other++; break; case "img": t.images++; break; default: e.name.includes("font") || e.name.includes(".woff") ? t.fonts++ : t.other++ } }), t } return null } analyzeCLSCauses(e) { e.forEach(e => { e.sources.forEach(e => { this.reportMetric("cls_source", { element: e.node?.tagName || "unknown", previousRect: e.previousRect, currentRect: e.currentRect }) }) }) } showOfflineIndicator() { window.showToast && window.showToast("You are currently offline", "warning", { duration: 0, actions: [{ text: "Dismiss", handler: () => { } }] }) } getMetrics() { return { ...this.metrics } } getNetworkInfo() { return { ...this.networkInfo } } startRecording() { this.isRecording = !0 } stopRecording() { this.isRecording = !1 } clearMetrics() { Object.keys(this.metrics).forEach(e => { this.metrics[e] = null }) } disconnect() { this.observers.forEach(e => { e.disconnect() }), this.observers.clear(), this.isRecording = !1 } } window.__imgLazyOwner = "performance";
const performanceMonitor = new PerformanceMonitor; window.performanceMonitor = performanceMonitor, window.performanceUtils = { measure: (e, t = "function") => { const r = performance.now(), o = e(), n = performance.now(); return Math.round(n - r), performanceMonitor.reportMetric("function_timing", { name: t, duration: Math.round(n - r) }), o }, measureAsync: async (e, t = "async function") => { const r = performance.now(), o = await e(), n = performance.now(); return Math.round(n - r), performanceMonitor.reportMetric("async_function_timing", { name: t, duration: Math.round(n - r) }), o }, getPerformanceState: () => ({ metrics: performanceMonitor.getMetrics(), network: performanceMonitor.getNetworkInfo(), memory: performance.memory ? { used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024), total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024), limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) } : null }) };
//# sourceMappingURL=performance.min.js.map
